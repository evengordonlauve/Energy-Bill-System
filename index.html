<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kostnads- og Inntektsfordeling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="p-4 font-[Inter] bg-gray-100 text-slate-700">
    <div id="root"></div>

    <!-- React and Babel from CDN for simplicity -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState } = React;

        function App() {
            const [totalArea, setTotalArea] = useState(1000);
            const [commonArea, setCommonArea] = useState(200);

            const [tenants, setTenants] = useState([
                { name: 'Butikk A', area: 300, electricity: 60, thermal: 3000, water: 20 },
                { name: 'Kontor B', area: 500, electricity: 25, thermal: 4000, water: 30 }
            ]);

            const [totalElectricityConsumption, setTotalElectricityConsumption] = useState(97);
            const [totalThermalConsumption, setTotalThermalConsumption] = useState(8000);
            const [totalWaterConsumption, setTotalWaterConsumption] = useState(60);
            const [solarProduction, setSolarProduction] = useState(300);

            const [spotPriceConsumption, setSpotPriceConsumption] = useState(0.64);
            const [spotPriceProduction, setSpotPriceProduction] = useState(0.64);
            const [solarDiscountPercentage, setSolarDiscountPercentage] = useState(25);
            const [gridRentFixed, setGridRentFixed] = useState(300);
            const [gridRentEnergy, setGridRentEnergy] = useState(0.3);
            const [thermalPrice, setThermalPrice] = useState(0.7);
            const [waterPrice, setWaterPrice] = useState(50);

            const [commonCostDistribution, setCommonCostDistribution] = useState('area');
            const [productionRevenueDistribution, setProductionRevenueDistribution] = useState('consumption');
            const [meteringModel, setMeteringModel] = useState('submeters');

            const [results, setResults] = useState(null);

            const addTenant = () => {
                setTenants([...tenants, { name: '', area: '', electricity: '', thermal: '', water: '' }]);
            };

            const deleteTenant = (index) => {
                const newTenants = tenants.slice();
                newTenants.splice(index, 1);
                setTenants(newTenants);
            };

            const handleTenantChange = (index, field, value) => {
                const newTenants = tenants.slice();
                newTenants[index][field] = value;
                setTenants(newTenants);
            };

            const calculate = () => {
                // Validation
                const tArea = parseFloat(totalArea);
                const cArea = parseFloat(commonArea);
                if (isNaN(tArea) || tArea <= 0) return;
                if (isNaN(cArea) || cArea < 0) return;

                const tenantData = [];
                let totalTenantArea = 0;
                let totalTenantElectricityDemand = 0;
                let totalTenantThermal = 0;
                let totalTenantWater = 0;

                tenants.forEach((t, idx) => {
                    const area = parseFloat(t.area);
                    const electricity = parseFloat(t.electricity);
                    const thermal = parseFloat(t.thermal);
                    const water = parseFloat(t.water);
                    tenantData.push({
                        id: idx + 1,
                        name: t.name || `Leietaker ${idx + 1}`,
                        area: isNaN(area) ? 0 : area,
                        electricity: isNaN(electricity) ? 0 : electricity,
                        thermal: isNaN(thermal) ? 0 : thermal,
                        water: isNaN(water) ? 0 : water,
                    });
                    totalTenantArea += isNaN(area) ? 0 : area;
                    totalTenantElectricityDemand += isNaN(electricity) ? 0 : electricity;
                    totalTenantThermal += isNaN(thermal) ? 0 : thermal;
                    totalTenantWater += isNaN(water) ? 0 : water;
                });

                if (totalTenantArea + cArea > tArea + 0.01) return;
                if (totalTenantElectricityDemand > parseFloat(totalElectricityConsumption) + 0.01) return;

                const totalThermalCostBuilding = parseFloat(totalThermalConsumption) * parseFloat(thermalPrice);
                const totalWaterCostBuilding = parseFloat(totalWaterConsumption) * parseFloat(waterPrice);

                const commonElectricityDemand = Math.max(0, parseFloat(totalElectricityConsumption) - totalTenantElectricityDemand);
                const commonThermalDemand = Math.max(0, parseFloat(totalThermalConsumption) - totalTenantThermal);
                const commonWaterDemand = Math.max(0, parseFloat(totalWaterConsumption) - totalTenantWater);

                const discountedSolarPrice = parseFloat(spotPriceConsumption) * (1 - parseFloat(solarDiscountPercentage)/100);

                let remainingSolar = parseFloat(solarProduction);
                let totalSolarConsumedInternally = 0;

                const tenantResults = tenantData.map(t => {
                    const allocated = Math.min(t.electricity, remainingSolar);
                    const solarUsed = allocated;
                    const gridNeeded = t.electricity - allocated;
                    remainingSolar -= allocated;
                    totalSolarConsumedInternally += allocated;
                    return { ...t, solarUsed, gridNeeded };
                });

                const commonAreaSolarUsed = Math.min(commonElectricityDemand, remainingSolar);
                const commonAreaGridNeeded = commonElectricityDemand - commonAreaSolarUsed;
                remainingSolar -= commonAreaSolarUsed;
                totalSolarConsumedInternally += commonAreaSolarUsed;

                const exportedSolar = remainingSolar;

                const totalGridElectricityCostBuilding = commonAreaGridNeeded * (parseFloat(spotPriceConsumption) + parseFloat(gridRentEnergy));

                let totalCommonCostsDistributed = 0;
                let totalBuildingExportRevenue = exportedSolar * parseFloat(spotPriceProduction);
                const totalBuildingElectricityDemand = totalTenantElectricityDemand + commonElectricityDemand;

                const finalTenantResults = tenantResults.map(t => {
                    const costFromSolar = t.solarUsed * discountedSolarPrice;
                    const costFromGrid = t.gridNeeded * (parseFloat(spotPriceConsumption) + parseFloat(gridRentEnergy));
                    const electricityCost = costFromSolar + costFromGrid;

                    const thermalCost = t.thermal * parseFloat(thermalPrice);
                    const waterCost = t.water * parseFloat(waterPrice);

                    const areaPercentage = tArea > 0 ? t.area / tArea : 0;
                    const gridRentFixedShare = parseFloat(gridRentFixed) * areaPercentage;
                    const commonElectricityShare = totalGridElectricityCostBuilding * areaPercentage;
                    const commonThermalShare = totalThermalCostBuilding * areaPercentage;
                    const commonWaterShare = totalWaterCostBuilding * areaPercentage;

                    const commonCostShare = gridRentFixedShare + commonElectricityShare + commonThermalShare + commonWaterShare;
                    totalCommonCostsDistributed += commonCostShare;

                    const totalCost = electricityCost + thermalCost + waterCost + commonCostShare;
                    let solarExportRevenue = 0;
                    let netCost = totalCost;
                    if (meteringModel === 'ams') {
                        const shareDemand = totalBuildingElectricityDemand > 0 ? (t.electricity / totalBuildingElectricityDemand) : 0;
                        solarExportRevenue = shareDemand * totalBuildingExportRevenue;
                        netCost = totalCost + solarExportRevenue;
                    }
                    return {
                        ...t,
                        solarUsed: t.solarUsed,
                        gridNeeded: t.gridNeeded,
                        electricityCost,
                        thermalCost,
                        waterCost,
                        commonCostShare,
                        totalCost,
                        solarExportRevenue,
                        netCost,
                    };
                });

                setResults({
                    tenants: finalTenantResults,
                    totalCommonCostsDistributed,
                    totalBuildingExportRevenue,
                });
            };

            const handleSave = () => {
                const data = {
                    totalArea,
                    commonArea,
                    tenants,
                    totalElectricityConsumption,
                    totalThermalConsumption,
                    totalWaterConsumption,
                    solarProduction,
                    spotPriceConsumption,
                    spotPriceProduction,
                    solarDiscountPercentage,
                    gridRentFixed,
                    gridRentEnergy,
                    thermalPrice,
                    waterPrice,
                    commonCostDistribution,
                    productionRevenueDistribution,
                    meteringModel
                };
                localStorage.setItem('calculatorData', JSON.stringify(data));
                alert('Data lagret');
            };

            const handleLoad = () => {
                const data = localStorage.getItem('calculatorData');
                if (!data) return;
                try {
                    const obj = JSON.parse(data);
                    setTotalArea(obj.totalArea);
                    setCommonArea(obj.commonArea);
                    setTenants(obj.tenants || []);
                    setTotalElectricityConsumption(obj.totalElectricityConsumption);
                    setTotalThermalConsumption(obj.totalThermalConsumption);
                    setTotalWaterConsumption(obj.totalWaterConsumption);
                    setSolarProduction(obj.solarProduction);
                    setSpotPriceConsumption(obj.spotPriceConsumption);
                    setSpotPriceProduction(obj.spotPriceProduction);
                    setSolarDiscountPercentage(obj.solarDiscountPercentage);
                    setGridRentFixed(obj.gridRentFixed);
                    setGridRentEnergy(obj.gridRentEnergy);
                    setThermalPrice(obj.thermalPrice);
                    setWaterPrice(obj.waterPrice);
                    setCommonCostDistribution(obj.commonCostDistribution);
                    setProductionRevenueDistribution(obj.productionRevenueDistribution);
                    setMeteringModel(obj.meteringModel);
                } catch (e) {}
            };

            return (
                <div className="container mx-auto max-w-4xl bg-white p-6 rounded-lg shadow">
                    <h1 className="text-3xl mb-6 text-center">Kostnads- og Inntektsfordeling i Eiendommer</h1>

                    {/* Section 1 */}
                    <div className="mb-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                        <h2 className="text-2xl border-b-2 border-blue-100 pb-2 mb-4">1. Bygg- og Leietakerstruktur</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block mb-1 font-semibold">Totalt Byggareal (m²):</label>
                                <input type="number" value={totalArea} onChange={e=>setTotalArea(e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block mb-1 font-semibold">Fellesareal (m²):</label>
                                <input type="number" value={commonArea} onChange={e=>setCommonArea(e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                        </div>

                        <h3 className="text-xl mt-6 mb-3">Leietakere</h3>
                        {tenants.map((t, idx) => (
                            <div key={idx} className="border p-4 bg-slate-50 rounded mb-4 relative">
                                <button className="absolute top-1 right-1 bg-red-500 text-white px-2 py-1 text-sm rounded" onClick={() => deleteTenant(idx)}>Slett</button>
                                <h4 className="font-semibold mb-2">Leietaker {idx+1}</h4>
                                <label className="block font-semibold">Navn:</label>
                                <input type="text" value={t.name} onChange={e=>handleTenantChange(idx,'name',e.target.value)} className="w-full p-2 border rounded mb-2" />
                                <label className="block font-semibold">Areal (m²):</label>
                                <input type="number" value={t.area} onChange={e=>handleTenantChange(idx,'area',e.target.value)} className="w-full p-2 border rounded mb-2" />
                                <label className="block font-semibold">El-forbruk (kWh/mnd):</label>
                                <input type="number" value={t.electricity} onChange={e=>handleTenantChange(idx,'electricity',e.target.value)} className="w-full p-2 border rounded mb-2" />
                                <label className="block font-semibold">Termisk forbruk (kWh/mnd):</label>
                                <input type="number" value={t.thermal} onChange={e=>handleTenantChange(idx,'thermal',e.target.value)} className="w-full p-2 border rounded mb-2" />
                                <label className="block font-semibold">Vannforbruk (m³/mnd):</label>
                                <input type="number" value={t.water} onChange={e=>handleTenantChange(idx,'water',e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                        ))}
                        <button onClick={addTenant} className="mt-2 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded">Legg til Leietaker</button>
                    </div>

                    {/* Section 2 */}
                    <div className="mb-8 p-6 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <h2 className="text-2xl border-b-2 border-yellow-100 pb-2 mb-4">2. Forbruks- og Produksjonsdata</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block font-semibold">Totalt El-forbruk Bygg (kWh/mnd):</label>
                                <input type="number" value={totalElectricityConsumption} onChange={e=>setTotalElectricityConsumption(e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block font-semibold">Totalt Termisk Forbruk Bygg (kWh/mnd):</label>
                                <input type="number" value={totalThermalConsumption} onChange={e=>setTotalThermalConsumption(e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block font-semibold">Totalt Vannforbruk Bygg (m³/mnd):</label>
                                <input type="number" value={totalWaterConsumption} onChange={e=>setTotalWaterConsumption(e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block font-semibold">Solcelleproduksjon (kWh/mnd):</label>
                                <input type="number" value={solarProduction} onChange={e=>setSolarProduction(e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                        </div>
                    </div>

                    {/* Section 3 */}
                    <div className="mb-8 p-6 bg-red-50 border border-red-200 rounded-lg">
                        <h2 className="text-2xl border-b-2 border-red-100 pb-2 mb-4">3. Prisstruktur</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block font-semibold">Spotpris Forbruk (kr/kWh):</label>
                                <input type="number" value={spotPriceConsumption} onChange={e=>setSpotPriceConsumption(e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block font-semibold">Spotpris Produksjon (kr/kWh):</label>
                                <input type="number" value={spotPriceProduction} onChange={e=>setSpotPriceProduction(e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block font-semibold">Rabatt på solstrøm (%):</label>
                                <input type="number" value={solarDiscountPercentage} onChange={e=>setSolarDiscountPercentage(e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block font-semibold">Nettleie Fastledd (kr/mnd):</label>
                                <input type="number" value={gridRentFixed} onChange={e=>setGridRentFixed(e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block font-semibold">Nettleie Energiledd (kr/kWh):</label>
                                <input type="number" value={gridRentEnergy} onChange={e=>setGridRentEnergy(e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block font-semibold">Pris Termisk Energi (kr/kWh):</label>
                                <input type="number" value={thermalPrice} onChange={e=>setThermalPrice(e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block font-semibold">Pris Vann (kr/m³):</label>
                                <input type="number" value={waterPrice} onChange={e=>setWaterPrice(e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                        </div>
                    </div>

                    {/* Section 4 */}
                    <div className="mb-8 p-6 bg-purple-50 border border-purple-200 rounded-lg">
                        <h2 className="text-2xl border-b-2 border-purple-100 pb-2 mb-4">4. Fordelingsnøkler og Målemodell</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block font-semibold">Felleskostnader fordeles etter:</label>
                                <select value={commonCostDistribution} onChange={e=>setCommonCostDistribution(e.target.value)} className="w-full p-2 border rounded">
                                    <option value="area">Arealprosent</option>
                                </select>
                            </div>
                            <div>
                                <label className="block font-semibold">Produksjonsinntekt fordeles etter:</label>
                                <select value={productionRevenueDistribution} onChange={e=>setProductionRevenueDistribution(e.target.value)} className="w-full p-2 border rounded">
                                    <option value="consumption">Andel av forbruk</option>
                                    <option value="area">Andel av areal</option>
                                </select>
                            </div>
                            <div>
                                <label className="block font-semibold">Målemodell for Solstrøm:</label>
                                <select value={meteringModel} onChange={e=>setMeteringModel(e.target.value)} className="w-full p-2 border rounded">
                                    <option value="submeters">Undermålere (eksport til gårdeier)</option>
                                    <option value="ams">AMS-målere (virtuell deling via Elhub)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Buttons */}
                    <div className="mb-8 flex flex-wrap gap-2">
                        <button onClick={calculate} className="flex-1 bg-indigo-500 text-white p-3 rounded">Beregn Kostnader og Inntekter</button>
                        <button onClick={handleSave} className="bg-gray-700 text-white p-3 rounded">Lagre</button>
                        <button onClick={handleLoad} className="bg-gray-500 text-white p-3 rounded">Last inn</button>
                    </div>

                    {results && (
                        <div className="p-6 bg-green-50 border border-green-200 rounded-lg">
                            <h2 className="text-2xl border-b-2 border-green-100 pb-2 mb-4">5. Resultater</h2>
                            {results.tenants.map((res, idx) => (
                                <div key={idx} className="mb-4 p-4 border border-gray-200 rounded-md bg-white">
                                    <h3 className="text-xl font-semibold mb-2">{res.name}</h3>
                                    <p><strong>El-forbruk (målt):</strong> {res.electricity.toFixed(2)} kWh</p>
                                    <p><strong>Tildelt solstrøm:</strong> {res.solarUsed.toFixed(2)} kWh</p>
                                    <p><strong>El-kostnad (fra solstrøm):</strong> {(res.solarUsed * (spotPriceConsumption * (1 - solarDiscountPercentage/100))).toFixed(2)} kr</p>
                                    <p><strong>El-kostnad (fra nett):</strong> {(res.gridNeeded * (parseFloat(spotPriceConsumption)+parseFloat(gridRentEnergy))).toFixed(2)} kr</p>
                                    <p><strong>Termisk kostnad:</strong> {res.thermalCost.toFixed(2)} kr</p>
                                    <p><strong>Vannkostnad:</strong> {res.waterCost.toFixed(2)} kr</p>
                                    <p><strong>Andel Felleskostnader:</strong> {res.commonCostShare.toFixed(2)} kr</p>
                                    <p className="text-blue-700"><strong>Total Kostnad (før eksportjustering):</strong> {res.totalCost.toFixed(2)} kr</p>
                                    {meteringModel === 'ams' && (
                                        <p className="text-red-700"><strong>Fakturert eksport (tilbakefaktureres gårdeier):</strong> {res.solarExportRevenue.toFixed(2)} kr</p>
                                    )}
                                    <p className="text-lg font-bold text-gray-800"><strong>Netto Kostnad for Leietaker:</strong> {res.netCost.toFixed(2)} kr</p>
                                </div>
                            ))}
                            <p className="text-lg"><strong>Totale Felleskostnader fordelt:</strong> {results.totalCommonCostsDistributed.toFixed(2)} kr</p>
                            <p className="text-lg"><strong>Total Solstrøm Eksportinntekt (til bygningseier):</strong> {results.totalBuildingExportRevenue.toFixed(2)} kr</p>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
